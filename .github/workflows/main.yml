name: CI

env:
  DISPLAY: ':99'
  ACTIONS_ALLOW_UNSECURE_COMMANDS: 'true'

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  workflow_dispatch:
  push:
    branches: [ master,  github-workflow-playground ]
  pull_request:
    branches: [ master ]
  schedule:
    - cron: "0 0 * * *"

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  window-build:
    runs-on: windows-latest
    strategy:
      matrix:
        config:
          - {python: true}
          - {python: false}

    steps:
      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: bluetiger9/SmtpClient-for-Qt
          path: "src/smtpclient/"
          ref: 7aa471c8a2c8d4109a3380aaea0cb24da2bf0f7a

      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: cagnulein/qmdnsengine
          path: "src/qmdnsengine/"
          ref: "zwift"   

      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: google/googletest
          path: "tst/googletest/"
          ref: "release-1.12.1"

      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: microsoft/MSIX-Toolkit
          path: "src/MSIX-Toolkit/"
          ref: b82af826d29e93e4c85d34fad8a405b6c49905e7

      - uses: actions/checkout@v2
      - name: Checkout qHttpServer
        uses: actions/checkout@v2
        with:
          repository: qt-labs/qthttpserver
          path: "src/qthttpserver"


      - uses: actions/setup-python@v4
        with:
          python-version: 3.7
      - name: download python and paddleocr
        run: |
          python -VV
          python -m pip install --upgrade pip
          python -m pip install --upgrade setuptools
          python -m pip install "protobuf<=3.20.2,>=3.1.0"
          python -m pip install paddlepaddle==2.5.1
          python -m pip install paddleocr
          python -m pip install imutils
          python -m pip install "Pillow<10.0.0"
          python -m pip install opencv-python
          python -m pip install numpy
          python -m pip install pywin32
        if: matrix.config.python

      - uses: msys2/setup-msys2@v2
        with:
          install: mingw-w64-x86_64-toolchain mingw-w64-x86_64-qt5-webview
          msystem: mingw64
          release: false

      - name: Setup cmake
        uses: jwlawson/actions-setup-cmake@v1.9
        with:
          cmake-version: '3.25.x'

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.9.1'
          host: 'windows'
          modules: 'qtnetworkauth qtcharts'
          target: "desktop"
          arch: win64_mingw81
          dir: "${{github.workspace}}/qt/"
          install-deps: "true"
          cache: 'true'
          cache-key-prefix: 'install-qt-action-windows'          

      - name: download 3rd party files for qthttpserver
        run: |
            cp qHttpServerBin/5.15.2/headers/* src/qthttpserver/src/3rdparty/http-parser/
      - name: Build qthttpserver
        run: |
            cd src\qthttpserver 
            qmake
            make -j8
            make install
            cd ../..
      - name: Secrets
        if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/qt6'
        run: |
          cd src
          echo "#define STRAVA_SECRET_KEY ${{ secrets.strava_secret_key }}" > secret.h
          echo "#define PELOTON_SECRET_KEY ${{ secrets.peloton_secret_key }}" >> secret.h
          echo "#define SMTP_USERNAME ${{ secrets.smtp_username }}" >> secret.h
          echo "#define SMTP_PASSWORD ${{ secrets.smtp_password }}" >> secret.h
          echo "#define SMTP_SERVER ${{ secrets.smtp_server }}" >> secret.h
          echo "${{ secrets.cesiumkey }}" >> inner_templates/googlemaps/cesium-key.js
          cd ..  
      - name: Build
        run: |
            qmake
            make -j8
            cd src/debug
            mkdir output
            mkdir appx
            cp qdomyos-zwift.* output/
            cd output
            windeployqt --qmldir ../../ qdomyos-zwift.exe
            cp "C:/mingw64/bin/libwinpthread-1.dll" .
            cp "C:/mingw64/bin/libgcc_s_seh-1.dll" .
            cp "C:/mingw64/bin/libstdc++-6.dll" .
            cp ../../../icons/iOS/iTunesArtwork@2x.png .
            cp ../../AppxManifest.xml .
            cp ../../windows/*.py .
            cp ../../windows/*.bat .
            cp ../../../windows_openssl/*.* .
            mkdir adb
            mkdir python
            Copy-Item -Path C:\hostedtoolcache\windows\Python\3.7.9\x64 -Destination python -Recurse
            cp ../../adb/* adb/
            cd ..
            cd appx
            #../../MSIX-Toolkit/WindowsSDK/10/10.0.20348.0/x64/makeappx.exe pack /d ../output/ /p qz   
        if: matrix.config.python
            
      - name: Build without python
        run: |
            qmake
            make -j8
            cd src/debug
            mkdir output
            mkdir appx
            cp qdomyos-zwift.* output/
            cd output
            windeployqt --qmldir ../../ qdomyos-zwift.exe
            cp "C:/mingw64/bin/libwinpthread-1.dll" .
            cp "C:/mingw64/bin/libgcc_s_seh-1.dll" .
            cp "C:/mingw64/bin/libstdc++-6.dll" .
            cp ../../../icons/iOS/iTunesArtwork@2x.png .
            cp ../../AppxManifest.xml .
            cp ../../../windows_openssl/*.* .
            mkdir adb
            cp ../../adb/* adb/
            cd ..
            cd appx
            #../../MSIX-Toolkit/WindowsSDK/10/10.0.20348.0/x64/makeappx.exe pack /d ../output/ /p qz          
        if: matrix.config.python == false

      - name: patching qt for bluetooth
        run: cp qt-patches/windows/5.15.2/binary/mingw64/*.* ${{ github.workspace }}/src/debug/output/

      - name: Zip artifact for deployment
        run: Compress-Archive src/debug/output windows-binary.zip
        if: matrix.config.python

      - name: Zip artifact for deployment
        run: Compress-Archive src/debug/output windows-binary-no-python.zip
        if:  ${{ ! matrix.config.python }}

      - name: Archive windows binary
        uses: actions/upload-artifact@v4
        with:
          name: windows-binary
          path: windows-binary.zip
        if: matrix.config.python

      - name: Archive windows binary
        uses: actions/upload-artifact@v4
        with:
          name: windows-binary-no-python
          path: windows-binary-no-python.zip
        if:  ${{ ! matrix.config.python }}

      # - name: Exit if not on master branch
      #   if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/qt6'
      #   run: exit 1

      # - uses: actions/checkout@v3
      #   with:
      #     fetch-depth: 0 # Required due to the way Git works, without it this action won't be able to find any or the correct tags

      # - name: Get previous tag
      #   id: previoustag
      #   uses: 'WyriHaximus/github-action-get-previous-tag@v1'
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}          

      # - name: Create Release
      #   if:  ${{ ! matrix.config.python }}
      #   id: create_release
      #   uses: actions/create-release@v1
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   with:
      #     tag_name: ${{ steps.previoustag.outputs.tag }}
      #     release_name: Release ${{ steps.previoustag.outputs.tag }}
      #     draft: false
      #     prerelease: false

      # - name: upload windows artifact
      #   uses: actions/upload-release-asset@v1
      #   if:  ${{ ! matrix.config.python }}
      #   env:
      #     GITHUB_TOKEN: ${{ github.token }}
      #   with:
      #     upload_url: ${{ steps.create_release.outputs.upload_url }}
      #     asset_path: release.zip
      #     asset_name: windows-binary-no-python.zip
      #     asset_content_type: application/zip        

      # - name: upload windows artifact
      #   uses: actions/upload-release-asset@v1
      #   if:  ${{ matrix.config.python }}
      #   env:
      #     GITHUB_TOKEN: ${{ github.token }}
      #   with:
      #     upload_url: ${{ steps.create_release.outputs.upload_url }}
      #     asset_path: release.zip
      #     asset_name: windows-binary.zip
      #     asset_content_type: application/zip        

#  window-steam-build:
#    runs-on: windows-latest
#
#    steps:
#      - uses: actions/checkout@v2
#      - name: Checkout submodule repo
#        uses: actions/checkout@v2
#        with:
#          repository: bluetiger9/SmtpClient-for-Qt
#          path: "src/smtpclient/"
#          ref: 7aa471c8a2c8d4109a3380aaea0cb24da2bf0f7a
#
#      - uses: actions/checkout@v2
#      - name: Checkout submodule repo
#        uses: actions/checkout@v2
#        with:
#          repository: cagnulein/qmdnsengine
#          path: "src/qmdnsengine/"
#          ref: "zwift"
#
#      - uses: msys2/setup-msys2@v2
#        with:
#          install: mingw-w64-x86_64-toolchain
#          msystem: mingw64
#          release: false
#
#      - name: Setup cmake
#        uses: jwlawson/actions-setup-cmake@v1.9
#        with:
#          cmake-version: '3.20.x'
#
#      - name: Install Qt
#        uses: jurplel/install-qt-action@v2
#        with:
#          version: '5.15.2'
#          host: 'windows'
#          modules: 'qtnetworkauth qtcharts'
#          target: "desktop"
#          arch: win64_mingw81
#          dir: "${{github.workspace}}/qt/"
#          install-deps: "true"
#
#      - name: Build
#        run: |
#            qmake
#            cd src
#            echo "#define STRAVA_SECRET_KEY ${{ secrets.strava_secret_key }}" > secret.h
#            echo "#define PELOTON_SECRET_KEY ${{ secrets.peloton_secret_key }}" >> secret.h
#            echo "#define SMTP_USERNAME ${{ secrets.smtp_username }}" >> secret.h
#            echo "#define SMTP_PASSWORD ${{ secrets.smtp_password }}" >> secret.h
#            echo "#define SMTP_SERVER ${{ secrets.smtp_server }}" >> secret.h
#            echo "${{ secrets.cesiumkey }}" >> inner_templates/googlemaps/cesium-key.js
#            echo "#define STEAM_STORE" >> secret.h
#            cd ..
#            make -j8
#            cd src/debug
#            mkdir output
#            mkdir appx
#            cp qdomyos-zwift.exe output/
#            cd output
#            windeployqt --qmldir ../../ qdomyos-zwift.exe
#            cp "${{github.workspace}}/qt/Qt/5.15.2/mingw81_64/bin/libwinpthread-1.dll" .
#            cp "${{github.workspace}}/qt/Qt/5.15.2/mingw81_64/bin/libgcc_s_seh-1.dll" .
#            cp "${{github.workspace}}/qt/Qt/5.15.2/mingw81_64/bin/libstdc++-6.dll" .
#
#      - uses: game-ci/steam-deploy@v1
#        with:
#          username: ${{ secrets.STEAM_USERNAME }}
#          password: ${{ secrets.STEAM_PASSWORD }}
#          configVdf: ${{ secrets.STEAM_CONFIG_VDF}}
#          ssfnFileName: ${{ secrets.STEAM_SSFN_FILE_NAME }}
#          ssfnFileContents: ${{ secrets.STEAM_SSFN_FILE_CONTENTS }}
#          appId: 2267200
#          buildDescription: 2.12
#          rootPath: src/debug/output
#          depot1Path: ./
#          #depot2Path: StandaloneLinux64
#          releaseBranch: prerelease

  # This workflow contains a single job called "build"
  linux-x86-build:
    # The type of runner that the job will run on
    runs-on: ubuntu-24.04

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: release
        uses: actions/create-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        id: create_release
        with:
          draft: false
          prerelease: false
          release_name: ${{ steps.version.outputs.version }}
          tag_name: ${{ github.ref }}
          body_path: CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ github.token }}

#      - name: Cache Qt Linux Desktop
#        id: cache-qt-linux-desktop
#        uses: actions/cache@v1
#        with:
#          path: '${{ github.workspace }}/output/linux-desktop/'
#          key: ${{ runner.os }}-QtCache-Linux-Desktop

#      - name: Cache Qt Linux Android
#        id: cache-qt-android
#        uses: actions/cache@v1
#        with:
#          path: '${{ github.workspace }}/output/android/'
#          key: ${{ runner.os }}-QtCache-Android

      - name: Xvfb install and run
        run: |
          sudo apt-get install -y xvfb
          Xvfb -ac ${{ env.DISPLAY }} -screen 0 1280x780x24 &
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: bluetiger9/SmtpClient-for-Qt
          path: "src/smtpclient/"
          ref: 7aa471c8a2c8d4109a3380aaea0cb24da2bf0f7a

      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: cagnulein/qmdnsengine
          path: "src/qmdnsengine/"
          ref: "zwift"

      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: google/googletest
          path: "tst/googletest/"
          ref: "release-1.12.1"

      - uses: actions/checkout@v2
      - name: Checkout qHttpServer
        uses: actions/checkout@v2
        with:
          repository: qt-labs/qthttpserver
          path: "src/qthttpserver"

      - name: Install packages required to run QZ inside workflow
        run: sudo apt update -y && sudo apt-get install -y qt6-base-dev qtchooser qmake6 qt6-base-dev-tools qml6-module-qtquick-controls libqt6bluetooth6 libqt6widgets6 libqt6positioning6 libqt6xml6 qt6-connectivity-dev qt6-positioning-dev libqt6charts6-dev libqt6charts6 libqt6networkauth6-dev libqt6websockets6-dev libxcb-randr0-dev libxcb-xtest0-dev libxcb-xinerama0-dev libxcb-shape0-dev libxcb-xkb-dev

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.9.1'
          host: 'linux'
          modules: 'qtnetworkauth qtcharts'
          cache: 'true'
          cache-key-prefix: 'install-qt-action-linux'                    

      - name: download 3rd party files for qthttpserver
        run: |
            cp qHttpServerBin/5.15.2/headers/* src/qthttpserver/src/3rdparty/http-parser/
      - name: Build qthttpserver
        run: |
            cd src/qthttpserver 
            qmake
            make -j8
            make install
            cd ../..
      - name: Compile Linux Desktop
        run: qmake; make -j8

      - name: Archive linux-desktop binary
        uses: actions/upload-artifact@v4
        with:
          name: linux-desktop-binary
          path: src/qdomyos-zwift         

      - name: Test
        run: cd tst; GTEST_OUTPUT=xml:test-results/ GTEST_COLOR=1 ./qdomyos-zwift-tests; cd ..

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test_results_xml
          path: tst/test-results/**/*.xml               

#      - name: Test Peloton API
#        if: github.event_name == 'push' || github.event_name == 'schedule'
#        run: cd /home/runner/work/qdomyos-zwift/qdomyos-zwift/src/; ./qdomyos-zwift -test-peloton -peloton-username ${{ secrets.peloton_username }} -peloton-password ${{ secrets.peloton_password }}
#        timeout-minutes: 2

#      - name: Test Home Fitness Buddy API
#        run: cd /home/runner/work/qdomyos-zwift/qdomyos-zwift/src/; ./qdomyos-zwift -test-hfb
#        timeout-minutes: 2

#      - uses: actions/checkout@v2
#        with:
#          repository: nttld/setup-ndk
#          path: setup-ndk
      # The packages.json in nttld/setup-ndk has already been updated,
      # https://github.com/nttld/setup-ndk/commit/831db5b02a0f0cab80614619efe461a3dcc140e6
      # but `dist/*` has not been rebuilt yet. Build it.
      # https://github.com/nttld/setup-ndk/tree/main/dist
#      - name: Locally rebuilt setup-ndk
#        run: |
#          npm -prefix ./setup-ndk install
#          npm -prefix ./setup-ndk run all
      # Install using locally rebuilt setup-ndk
#      - name: Setup Android NDK r21d
#        uses: ./setup-ndk
      #- uses: nttld/setup-ndk@v1
#        with:
#          ndk-version: r21d

# waiting github.com/jurplel/install-qt-action/issues/63
#      - name: Install Qt Android
#        uses: jurplel/install-qt-action@v2
#        with:
#          version: '5.12.9'
#          host: 'linux'
#          target: 'android'
#          arch: 'android_armv7'
#          modules: 'qtcharts debug_info'
#          dir: '${{ github.workspace }}/output/android/'
#          cached: ${{ steps.cache-qt-android.outputs.cache-hit }}

#      - name: Compile Android
#        run: cd src; qmake; make -j4

#      - name: Install Qt MacOS
#        uses: jurplel/install-qt-action@v2
#        with:
#          version: '5.12.9'
#          host: 'mac'
#          target: 'desktop'
#          modules: 'qtcharts debug_info'
#          dir: '${{ github.workspace }}/output/macos/'

#      - name: Compile MacOS
#        run: cd src; qmake; make -j4


  # This workflow contains a single job called "build"
  android-build:
    # The type of runner that the job will run on
    runs-on: ubuntu-22.04

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
#      - name: Cache Qt Linux Desktop
#        id: cache-qt-linux-desktop
#        uses: actions/cache@v1
#        with:
#          path: '${{ github.workspace }}/output/linux-desktop/'
#          key: ${{ runner.os }}-QtCache-Linux-Desktop

#      - name: Cache Qt Linux Android
#        id: cache-qt-android
#        uses: actions/cache@v1
#        with:
#          path: '${{ github.workspace }}/output/android/'
#          key: ${{ runner.os }}-QtCache-Android

      - name: Xvfb install and run
        run: |
          sudo apt-get install -y xvfb
          Xvfb -ac ${{ env.DISPLAY }} -screen 0 1280x780x24 &
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: qt6-android
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: 'false'  # Prima disattiva il checkout automatico dei submodule
        
      - name: Checkout submodules with specific branches
        run: |
          git submodule init
          git submodule update --init --recursive 
      - name: Fix qmdnsengine submodule
        run: |
          cd src/qmdnsengine
          git fetch
          git checkout 8a973df29234d8bcc7e9a5b9c64efa7e6f44d1ad
      - name: Install packages required to run QZ inside workflow
        run: sudo apt update -y && sudo apt-get install -y qt6-base-dev qtchooser qmake6 qt6-base-dev-tools qml6-module-qtquick-controls libqt6bluetooth6 libqt6widgets6 libqt6positioning6 libqt6xml6 qt6-connectivity-dev qt6-positioning-dev libqt6charts6-dev libqt6charts6 libqt6networkauth6-dev libqt6websockets6-dev libxcb-randr0-dev libxcb-xtest0-dev libxcb-xinerama0-dev libxcb-shape0-dev libxcb-xkb-dev
          
#      - name: Test Peloton API
#        if: github.event_name == 'push' || github.event_name == 'schedule'
#        run: cd /home/runner/work/qdomyos-zwift/qdomyos-zwift/src/; ./qdomyos-zwift -test-peloton -peloton-username ${{ secrets.peloton_username }} -peloton-password ${{ secrets.peloton_password }}
#        timeout-minutes: 2

#      - name: Test Home Fitness Buddy API
#        run: cd /home/runner/work/qdomyos-zwift/qdomyos-zwift/src/; ./qdomyos-zwift -test-hfb
#        timeout-minutes: 2

#      - uses: actions/checkout@v2
#        with:
#          repository: nttld/setup-ndk
#          path: setup-ndk
      # The packages.json in nttld/setup-ndk has already been updated,
      # https://github.com/nttld/setup-ndk/commit/831db5b02a0f0cab80614619efe461a3dcc140e6
      # but `dist/*` has not been rebuilt yet. Build it.
      # https://github.com/nttld/setup-ndk/tree/main/dist
#      - name: Locally rebuilt setup-ndk
#        run: |
#          npm -prefix ./setup-ndk install
#          npm -prefix ./setup-ndk run all
      # Install using locally rebuilt setup-ndk
#      - name: Setup Android NDK r21d
#        uses: ./setup-ndk
      #- uses: nttld/setup-ndk@v1
#        with:
#          ndk-version: r21d

# waiting github.com/jurplel/install-qt-action/issues/63
      - name: Install Qt Android (Host tools)
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.9.1'
          host: 'linux'
          target: 'desktop'
          modules: 'qtnetworkauth qtcharts qtconnectivity qtpositioning qtwebsockets qtlocation qtmultimedia qt5compat qtspeech'
          dir: '${{ github.workspace }}/output/android/'
          cache: 'true'
          cache-key-prefix: 'install-qt-action-android-host'

      - name: Install Qt Android (ARM64)
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.9.1'
          host: 'linux'
          target: 'android'
          arch: 'android_arm64_v8a'
          modules: 'qtnetworkauth qtcharts qtconnectivity qtpositioning qtwebsockets qtlocation qtmultimedia qt5compat qtspeech'
          dir: '${{ github.workspace }}/output/android/'
          cache: 'true'
          cache-key-prefix: 'install-qt-action-android-arm64'

      - name: Install Qt Android (ARMv7)
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.9.1'
          host: 'linux'
          target: 'android'
          arch: 'android_armv7'
          modules: 'qtnetworkauth qtcharts qtconnectivity qtpositioning qtwebsockets qtlocation qtmultimedia qt5compat qtspeech'
          dir: '${{ github.workspace }}/output/android/'
          cache: 'true'
          cache-key-prefix: 'install-qt-action-android-armv7'

      - name: Install Qt Android (x86)
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.9.1'
          host: 'linux'
          target: 'android'
          arch: 'android_x86'
          modules: 'qtnetworkauth qtcharts qtconnectivity qtpositioning qtwebsockets qtlocation qtmultimedia qt5compat qtspeech'
          dir: '${{ github.workspace }}/output/android/'
          cache: 'true'
          cache-key-prefix: 'install-qt-action-android-x86'

      - name: Install Qt Android (x86_64)
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.9.1'
          host: 'linux'
          target: 'android'
          arch: 'android_x86_64'
          modules: 'qtnetworkauth qtcharts qtconnectivity qtpositioning qtwebsockets qtlocation qtmultimedia qt5compat qtspeech'
          dir: '${{ github.workspace }}/output/android/'
          cache: 'true'
          cache-key-prefix: 'install-qt-action-android-x86_64'                    

      - name: Install Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin' # See 'Supported distributions' for available options
          java-version: '17'
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: 8.10
          
#      - name: patching qt for bluetooth
#        run: cp qt-patches/android/5.15.0/jar/*.* ${{ github.workspace }}/output/android/Qt/5.15.0/android/jar/

      - name: download 3rd party files for qthttpserver
        run: cp qHttpServerBin/5.15.2/headers/* src/qthttpserver/src/3rdparty/http-parser/

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v1.9
        with:
          cmake-version: '3.25.x'

      - name: Set Android NDK 25 && build with CMake
        run: |
          # Install NDK 25 for Qt 6.9.1 compatibility
          # https://github.com/actions/virtual-environments/issues/5595
          ANDROID_ROOT="/usr/local/lib/android"
          ANDROID_SDK_ROOT="${ANDROID_ROOT}/sdk"
          SDKMANAGER="${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager"
          echo "y" | $SDKMANAGER "ndk;25.2.9519653"
          echo "y" | $SDKMANAGER "platforms;android-35"
          echo "y" | $SDKMANAGER "build-tools;34.0.0"
          export ANDROID_NDK="${ANDROID_SDK_ROOT}/ndk-bundle"
          export ANDROID_NDK_ROOT="${ANDROID_NDK}"
          cd src
          echo "#define STRAVA_SECRET_KEY ${{ secrets.strava_secret_key }}" > secret.h
          echo "#define PELOTON_SECRET_KEY ${{ secrets.peloton_secret_key }}" >> secret.h
          echo "#define SMTP_USERNAME ${{ secrets.smtp_username }}" >> secret.h
          echo "#define SMTP_PASSWORD ${{ secrets.smtp_password }}" >> secret.h
          echo "#define SMTP_SERVER ${{ secrets.smtp_server }}" >> secret.h
          echo "${{ secrets.cesiumkey }}" >> inner_templates/googlemaps/cesium-key.js
          echo "#define LICENSE" >> secret.h
          cd ..          
          ln -sfn $ANDROID_SDK_ROOT/ndk/25.2.9519653 $ANDROID_NDK
          # Remove old NDK versions if they exist
          rm -rf /usr/local/lib/android/sdk/ndk/21.4.7075529 || true
          
          # Clean previous build
          rm -rf build-android-multiabi
          mkdir build-android-multiabi
          cd build-android-multiabi
          
          # Configure with CMake for multi-ABI build - single APK with all architectures
          export ANDROID_COMPILE_SDK_VERSION=35
          export ANDROID_TARGET_SDK_VERSION=35
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE="$ANDROID_NDK_ROOT/build/cmake/android.toolchain.cmake" \
            -DQT_HOST_PATH="${{ github.workspace }}/output/android/Qt/6.9.1/gcc_64" \
            -DCMAKE_PREFIX_PATH="${{ github.workspace }}/output/android/Qt/6.9.1/android_arm64_v8a" \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-24 \
            -DANDROID_STL=c++_shared \
            -DCMAKE_BUILD_TYPE=Release \
            -DQT_ANDROID_BUILD_ALL_ABIS=ON \
            -DQT_ANDROID_ABIS="armeabi-v7a;arm64-v8a" \
            -DQT_ANDROID_ABIS_PATH="${{ github.workspace }}/output/android/Qt/6.9.1/android_armv7;${{ github.workspace }}/output/android/Qt/6.9.1/android_arm64_v8a" \
            -DCMAKE_FIND_ROOT_PATH_MODE_PACKAGE=BOTH \
            -DANDROID_SDK_ROOT="$ANDROID_SDK_ROOT" \
            -DANDROID_NDK_ROOT="$ANDROID_NDK_ROOT"
          
          # Build the project for all ABIs with verbose output
          cmake --build . --parallel 4 --verbose
          
          cd ..
          
          # Create gradle.properties for Android build
          cat > src/android/gradle.properties << EOF
          android.useAndroidX=true
          android.enableJetifier=true
          androidBuildToolsVersion=34.0.0
          androidCompileSdkVersion=35
          qt5AndroidDir=/opt/Qt/5.15.2/android
          EOF
          
          # Create deployment settings for androiddeployqt with multi-ABI support
          cat > android-qdomyos-zwift-deployment-settings.json << EOF
          {
             "android-extra-libs": "${{ github.workspace }}/android_openssl/no-asm/latest/arm/libcrypto_1_1.so,${{ github.workspace }}/android_openssl/no-asm/latest/arm/libssl_1_1.so,${{ github.workspace }}/android_openssl/no-asm/latest/arm64/libcrypto_1_1.so,${{ github.workspace }}/android_openssl/no-asm/latest/arm64/libssl_1_1.so,${{ github.workspace }}/android_openssl/no-asm/latest/x86/libcrypto_1_1.so,${{ github.workspace }}/android_openssl/no-asm/latest/x86/libssl_1_1.so,${{ github.workspace }}/android_openssl/no-asm/latest/x86_64/libcrypto_1_1.so,${{ github.workspace }}/android_openssl/no-asm/latest/x86_64/libssl_1_1.so",
             "description": "This file is generated by CMake to be read by androiddeployqt and should not be modified by hand.",
             "qt": "${{ github.workspace }}/output/android/Qt/6.9.1/android",
             "sdk": "$ANDROID_SDK_ROOT",
             "ndk": "$ANDROID_NDK_ROOT",
             "toolchain-prefix": "llvm",
             "tool-prefix": "llvm",
             "toolchain-version": "25.2.9519653",
             "build-tools-version": "34.0.0",
             "ndk-host": "linux-x86_64",
             "android-abis": ["armeabi-v7a", "arm64-v8a", "x86", "x86_64"],
             "target-architecture": "arm64-v8a",
             "application-binary": "build-android-multiabi/qdomyos-zwift"
          }
          EOF
          cat android-qdomyos-zwift-deployment-settings.json
      - name: Build APK with Multi-ABI support
        run: |
          # Set Gradle arguments for detailed error reporting
          export GRADLE_OPTS="--stacktrace --info"
          
          # Use androiddeployqt to build APK with all ABIs
          androiddeployqt --input android-qdomyos-zwift-deployment-settings.json \
            --output ${{ github.workspace }}/output/android/ \
            --android-platform android-35 \
            --gradle \
            --aab \
            --verbose
          
          # Remove deprecated enableUncompressedNativeLibs from generated files
          find ${{ github.workspace }}/output/android/ -name "*.gradle" -exec sed -i '/android\.bundle\.enableUncompressedNativeLibs/d' {} \;
          find ${{ github.workspace }}/output/android/ -name "gradle.properties" -exec sed -i '/android\.bundle\.enableUncompressedNativeLibs/d' {} \;

      - name: Archive apk binary
        uses: actions/upload-artifact@v4
        with:
          name: fdroid-android-trial
          path: ${{ github.workspace }}/output/android/build/outputs/apk/debug/
          
      - name: Archive build problems report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: android-build-problems-report
          path: |
            ${{ github.workspace }}/build-android-multiabi/src/android-build/build/reports/problems/problems-report.html
            ${{ github.workspace }}/output/android/build/reports/problems/problems-report.html

  android-emulator-test:
    runs-on: ubuntu-latest
    needs: android-build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
        
      # Download the APK from the previous job
      - name: Download APK Artifact
        uses: actions/download-artifact@v4
        with:
          name: fdroid-android-trial
          path: apk-debug
          
      - name: Setup Java for Android Emulator
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      # Use a smaller emulator configuration
      - name: Run tests on emulator
        uses: ReactiveCircus/android-emulator-runner@v2
        with:
          target: default  # Use default instead of Google APIs
          arch: x86
          api-level: 29
          profile: Nexus 6
          disable-animations: true
          script: |
            # Display available space
            df -h
            
            # List available files
            echo "Files in apk-debug directory:"
            ls -la apk-debug/
            
            # Install the APK
            adb install apk-debug/android-debug.apk
            
            # Grant necessary permissions for API 25
            echo "Granting permissions..."
            adb shell pm grant org.cagnulen.qdomyoszwift android.permission.ACCESS_FINE_LOCATION || true
            adb shell pm grant org.cagnulen.qdomyoszwift android.permission.BLUETOOTH || true
            adb shell pm grant org.cagnulen.qdomyoszwift android.permission.BLUETOOTH_ADMIN || true
            adb shell pm grant org.cagnulen.qdomyoszwift android.permission.READ_EXTERNAL_STORAGE || true
            adb shell pm grant org.cagnulen.qdomyoszwift android.permission.WRITE_EXTERNAL_STORAGE || true
            
            # Start the main activity
            adb shell am start -n org.cagnulen.qdomyoszwift/org.qtproject.qt5.android.bindings.QtActivity
            
            # Wait for app to start
            sleep 40
            
            # Verify the app is running
            echo "Checking if app is running..."
            adb shell "ps -A" > process_list.txt
            grep -q "qdomyos" process_list.txt || (echo "App process not found in process list" && echo "TEST FAILED: App process not running" && exit 1)
            echo "App is running successfully"
            
            # Take a screenshot for verification
            adb shell screencap -p /sdcard/screenshot.png
            adb pull /sdcard/screenshot.png
            
            # Check if the package is installed
            adb shell pm list packages | grep org.cagnulen.qdomyoszwift
            
            # Display logcat output for debugging (just the last 100 lines)
            adb logcat -d | grep -i qdomyos | tail -n 100
      - name: Upload test evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-emulator-test-evidence
          path: |
            screenshot.png
            process_list.txt
          if-no-files-found: warn                

  ios-build:
    # The type of runner that the job will run on
    runs-on: macos-14
    permissions:
      contents: write

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: bluetiger9/SmtpClient-for-Qt
          path: "src/smtpclient/"
          ref: 7aa471c8a2c8d4109a3380aaea0cb24da2bf0f7a

      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: cagnulein/qmdnsengine
          path: "src/qmdnsengine/"
          ref: "zwift"

      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: google/googletest
          path: "tst/googletest/"
          ref: "release-1.12.1"

      - name: Install Qt iOS
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.9.1'
          host: 'mac'
          target: 'ios'
          modules: 'qtcharts  qtnetworkauth'
          dir: '${{ github.workspace }}/output/ios/'
          cache: 'true'
          cache-key-prefix: 'install-qt-action-ios'                    
          
      - name: fix qt
        run: find ${{ github.workspace }}/output/ios/ -name 'ios.conf' -exec sed -i '' 's/ios-simulator/iphonesimulator/g' {} \;
      
      - name: fix qt
        run: find ${{ github.workspace }}/output/ios/ -name 'devices.py' -exec sed -i '' 's/\/usr\/bin\/python/\/usr\/bin\/python3/g' {} \;        

      - name: fix qt
        run: find ./ -name 'qdomyos-zwift-lib.pro' -exec sed -i '' 's/TARGET = qdomyos-zwift/TARGET = qdomyoszwift/g' {} \;                

      - name: patching qt for bluetooth
        run: cp qt-patches/ios/5.15.2/binary/*.* ${{ github.workspace }}/output/ios/Qt/5.15.2/ios/lib/

      - name: Build
        run: |
          cd src
          echo "#define STRAVA_SECRET_KEY ${{ secrets.strava_secret_key }}" > secret.h
          echo "#define PELOTON_SECRET_KEY ${{ secrets.peloton_secret_key }}" >> secret.h
          echo "#define SMTP_USERNAME ${{ secrets.smtp_username }}" >> secret.h
          echo "#define SMTP_PASSWORD ${{ secrets.smtp_password }}" >> secret.h
          echo "#define SMTP_SERVER ${{ secrets.smtp_server }}" >> secret.h
          echo "${{ secrets.cesiumkey }}" >> inner_templates/googlemaps/cesium-key.js
          cd ..
          qmake CONFIG+=debug && make -j4
      # causes iOS build on Mac to fail
      # - name: Commit moc files
      #   uses: EndBug/add-and-commit@v9
      #   with:
      #     message: 'moc files added'
      #     add: 'src/moc_*.cpp --force'
      #   if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/qt6'

  window-msvc2022-build:
    runs-on: windows-latest
    strategy:
      matrix:
        config:
          - {python: true}
          - {python: false}    

    steps:
      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: bluetiger9/SmtpClient-for-Qt
          path: "src/smtpclient/"

      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: cagnulein/qmdnsengine
          path: "src/qmdnsengine/"
          ref: "zwift"   

      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: google/googletest
          path: "tst/googletest/"
          ref: "release-1.12.1"

      - uses: actions/checkout@v2
      - name: Checkout qHttpServer
        uses: actions/checkout@v2
        with:
          repository: qt-labs/qthttpserver
          path: "src/qthttpserver"

      - uses: actions/setup-python@v4
        with:
          python-version: 3.7
      - name: download python and paddleocr
        run: |
          python -VV
          python -m pip install --upgrade pip
          python -m pip install --upgrade setuptools
          python -m pip install "protobuf<=3.20.2,>=3.1.0"
          python -m pip install paddlepaddle==2.5.1
          python -m pip install paddleocr
          python -m pip install imutils
          python -m pip install "Pillow<10.0.0"
          python -m pip install opencv-python
          python -m pip install numpy
          python -m pip install pywin32
        if: matrix.config.python          

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.9.1'
          host: 'windows'
          modules: 'qtnetworkauth qtcharts qtconnectivity qtspeech qtpositioning qtwebsockets qtlocation qtmultimedia qtwebengine qtwebview qtwebchannel qthttpserver'
          target: "desktop"
          arch: win64_msvc2022_64
          dir: "${{github.workspace}}/qt/"
          install-deps: "true"
          cache: 'true'
          cache-key-prefix: 'install-qt-action-windows'          

      - name: Install MSVC compiler
        uses: ilammy/msvc-dev-cmd@v1
        with: 
          # 14.1 is for vs2017, 14.2 is vs2019, following the upstream vcpkg build from Qv2ray-deps repo
          #toolset: 14.2
          arch: x64

      # - name: download 3rd party files for qthttpserver
      #   run: |
      #       cp qHttpServerBin/5.15.2/headers/* src/qthttpserver/src/3rdparty/http-parser/

      # - name: Build qthttpserver
      #   run: |
      #       cd src\qthttpserver 
      #       qmake
      #       nmake
      #       nmake install
      #       cd ../..          

      - name: Secrets
        if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/qt6'
        run: |
          cd src
          echo "#define STRAVA_SECRET_KEY ${{ secrets.strava_secret_key }}" > secret.h
          echo "#define PELOTON_SECRET_KEY ${{ secrets.peloton_secret_key }}" >> secret.h
          echo "#define SMTP_USERNAME ${{ secrets.smtp_username }}" >> secret.h
          echo "#define SMTP_PASSWORD ${{ secrets.smtp_password }}" >> secret.h
          echo "#define SMTP_SERVER ${{ secrets.smtp_server }}" >> secret.h
          echo "${{ secrets.cesiumkey }}" >> inner_templates/googlemaps/cesium-key.js
          cd ..        
      - name: Clone vcpkg
        run: git clone https://github.com/microsoft/vcpkg.git
        working-directory: ${{ runner.workspace }}
  
      - name: Bootstrap vcpkg
        run: .\vcpkg\bootstrap-vcpkg.bat
        working-directory: ${{ runner.workspace }}
        
      - name: Create vcpkg.json
        working-directory: ${{ runner.workspace }}
        run: |
          echo '{
            "name": "qdomyos-zwift",
            "$schema": "https://raw.githubusercontent.com/microsoft/vcpkg-tool/main/docs/vcpkg.schema.json",
            "dependencies": [
              "protobuf",
              "protobuf-c",
              "abseil"
            ],
            "builtin-baseline": "8c2fcacefba009d63672f9d137f192765e632c9f"
          }' > vcpkg.json
      
      - name: Install dependencies
        run: |
          .\vcpkg\vcpkg install --triplet x64-windows --x-install-root=${{ runner.workspace }}\vcpkg\installed
        working-directory: ${{ runner.workspace }}
  
      - name: Build
            Copy-Item -Path ${{ runner.workspace }}\vcpkg\installed\x64-windows\lib\*.* -Destination . -Verbose
            Copy-Item -Path ${{ runner.workspace }}\vcpkg\installed\x64-windows\lib\*.* -Destination src/ -Verbose           
            Copy-Item -Path ${{ runner.workspace }}\vcpkg\installed\x64-windows\include\* -Destination src/ -Recurse -Verbose
        run: |
            qmake            
            nmake
            cd src/debug
            mkdir output
            mkdir appx
            cp qdomyos-zwift.* output/
            cd output
            windeployqt --qmldir ../../ qdomyos-zwift.exe
            cp ../../../icons/iOS/iTunesArtwork@2x.png .
            cp ../../AppxManifest.xml .
            cp ../../windows/*.py .
            cp ../../windows/*.bat .
            cp ../../../windows_openssl/*.* .
            Copy-Item -Path ${{ runner.workspace }}\vcpkg\installed\x64-windows\bin\*.* -Destination . -Verbose
            mkdir adb
            mkdir python
            Copy-Item -Path C:\hostedtoolcache\windows\Python\3.7.9\x64 -Destination python -Recurse
            cp ../../adb/* adb/
            cd ..
            cd appx
            #../../MSIX-Toolkit/WindowsSDK/10/10.0.20348.0/x64/makeappx.exe pack /d ../output/ /p qz   
        if: matrix.config.python

            
      - name: Build without python
#            Copy-Item -Path ${{ runner.workspace }}\vcpkg\installed\x64-windows\lib\*.* -Destination . -Verbose
#            Copy-Item -Path ${{ runner.workspace }}\vcpkg\installed\x64-windows\lib\*.* -Destination src/ -Verbose      
#            Copy-Item -Path ${{ runner.workspace }}\vcpkg\installed\x64-windows\include\* -Destination src/ -Recurse -Verbose     
        run: |          
            qmake           
            nmake
            cd src/debug
            mkdir output
            mkdir appx
            cp qdomyos-zwift.* output/
            cd output
            windeployqt --qmldir ../../ qdomyos-zwift.exe
            cp "C:/mingw64/bin/libwinpthread-1.dll" .
            cp "C:/mingw64/bin/libgcc_s_seh-1.dll" .
            cp "C:/mingw64/bin/libstdc++-6.dll" .              
            cp ../../../icons/iOS/iTunesArtwork@2x.png .
            cp ../../AppxManifest.xml .
            cp ../../../windows_openssl/*.* .
            Copy-Item -Path ${{ runner.workspace }}\vcpkg\installed\x64-windows\bin\*.* -Destination . -Verbose
            mkdir adb
            cp ../../adb/* adb/
            cd ..
            cd appx
            #../../MSIX-Toolkit/WindowsSDK/10/10.0.20348.0/x64/makeappx.exe pack /d ../output/ /p qz          
        if: matrix.config.python == false            

      - name: patching qt for bluetooth
        run: cp qt-patches/windows/5.15.2/binary/msvc2019/*.* ${{ github.workspace }}/src/debug/output/

      - name: Zip artifact for deployment
        run: Compress-Archive src/debug/output windows-msvc2022-binary.zip
        if: matrix.config.python

      - name: Zip artifact for deployment
        run: Compress-Archive src/debug/output windows-msvc2022-binary-no-python.zip
        if:  ${{ ! matrix.config.python }}

      - name: Archive windows binary
        uses: actions/upload-artifact@v4
        with:
          name: windows-msvc2022-binary
          path: windows-msvc2022-binary.zip
        if: matrix.config.python

      - name: Archive windows binary
        uses: actions/upload-artifact@v4
        with:
          name: windows-msvc2022-binary-no-python
          path: windows-msvc2022-binary-no-python.zip
        if:  ${{ ! matrix.config.python }}

  window-msvc2022-aiserver-build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: bluetiger9/SmtpClient-for-Qt
          path: "src/smtpclient/"
          ref: 7aa471c8a2c8d4109a3380aaea0cb24da2bf0f7a

      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: cagnulein/qmdnsengine
          path: "src/qmdnsengine/"
          ref: "zwift"   

      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: google/googletest
          path: "tst/googletest/"
          ref: "release-1.12.1"

      - uses: actions/checkout@v2
      - name: Checkout qHttpServer
        uses: actions/checkout@v2
        with:
          repository: qt-labs/qthttpserver
          path: "src/qthttpserver"      

      - name: Install CMake
        uses: lukka/get-cmake@latest
  
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '5.15.2'
          host: 'windows'
          modules: 'qtnetworkauth qtcharts'
          target: "desktop"
          arch: win64_msvc2019_64
          dir: "${{github.workspace}}/qt/"
          install-deps: "true"
          cache: 'true'
          cache-key-prefix: 'install-qt-action-windows'          

      - name: Install MSVC compiler
        uses: ilammy/msvc-dev-cmd@v1
        with: 
          # 14.1 is for vs2017, 14.2 is vs2019, following the upstream vcpkg build from Qv2ray-deps repo
          toolset: 14.2
          arch: x64

      - name: download 3rd party files for qthttpserver
        run: |
            cp qHttpServerBin/5.15.2/headers/* src/qthttpserver/src/3rdparty/http-parser/
      - name: Build qthttpserver
        run: |
            cd src\qthttpserver 
            qmake
            nmake
            nmake install
            cd ../..          
      - name: Secrets
        if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/qt6'
        run: |
          cd src
          echo "#define STRAVA_SECRET_KEY ${{ secrets.strava_secret_key }}" > secret.h
          echo "#define PELOTON_SECRET_KEY ${{ secrets.peloton_secret_key }}" >> secret.h
          echo "#define SMTP_USERNAME ${{ secrets.smtp_username }}" >> secret.h
          echo "#define SMTP_PASSWORD ${{ secrets.smtp_password }}" >> secret.h
          echo "#define SMTP_SERVER ${{ secrets.smtp_server }}" >> secret.h          
          echo "${{ secrets.cesiumkey }}" >> inner_templates/googlemaps/cesium-key.js
          cd ..                    
      - name: Clone vcpkg
        run: git clone https://github.com/microsoft/vcpkg.git
        working-directory: ${{ runner.workspace }}
  
      - name: Bootstrap vcpkg
        run: .\vcpkg\bootstrap-vcpkg.bat
        working-directory: ${{ runner.workspace }}
        
      - name: Create vcpkg.json
        working-directory: ${{ runner.workspace }}
        run: |
          echo '{
            "name": "qdomyos-zwift",
            "$schema": "https://raw.githubusercontent.com/microsoft/vcpkg-tool/main/docs/vcpkg.schema.json",
            "dependencies": [
              "protobuf",
              "protobuf-c",
              "abseil"
            ],
            "builtin-baseline": "8c2fcacefba009d63672f9d137f192765e632c9f"
          }' > vcpkg.json
      
      - name: Install dependencies
        run: |
          .\vcpkg\vcpkg install --triplet x64-windows --x-install-root=${{ runner.workspace }}\vcpkg\installed
        working-directory: ${{ runner.workspace }}

      - name: Build
        run: |
            Copy-Item -Path ${{ runner.workspace }}\vcpkg\installed\x64-windows\lib\*.* -Destination . -Verbose
            Copy-Item -Path ${{ runner.workspace }}\vcpkg\installed\x64-windows\lib\*.* -Destination src/ -Verbose           
            Copy-Item -Path ${{ runner.workspace }}\vcpkg\installed\x64-windows\include\* -Destination src/ -Recurse -Verbose
            cd src
            echo "#define AISERVER" >> aiserver.h
            cd ..
            qmake
            nmake
            cd src/debug
            mkdir output
            mkdir appx
            cp qdomyos-zwift.* output/
            cd output
            windeployqt --qmldir ../../ qdomyos-zwift.exe
            cp ../../../icons/iOS/iTunesArtwork@2x.png .
            cp ../../AppxManifest.xml .
            cp ../../windows/zwift-incline-ai-server.py zwift-incline.py
            cp ../../windows/zwift-incline-climb-portal-ai-server.py zwift-incline-climb-portal.py
            cp ../../windows/zwift-workout-ai-server.py zwift-workout.py
            cp ../../windows/*.bat .
            cp ../../../windows_openssl/*.* .
            Copy-Item -Path ${{ runner.workspace }}\vcpkg\installed\x64-windows\bin\*.* -Destination . -Verbose
            mkdir adb
            cp ../../adb/* adb/
            cd ..
            cd appx
            #../../MSIX-Toolkit/WindowsSDK/10/10.0.20348.0/x64/makeappx.exe pack /d ../output/ /p qz                      
      - name: patching qt for bluetooth
        run: cp qt-patches/windows/5.15.2/binary/msvc2019/*.* ${{ github.workspace }}/src/debug/output/

      - name: Zip artifact for deployment
        run: Compress-Archive src/debug/output windows-msvc2022-ai-server-binary.zip

      - name: Archive windows binary
        uses: actions/upload-artifact@v4
        with:
          name: windows-msvc2022-ai-server-binary
          path: windows-msvc2022-ai-server-binary.zip

  raspberry-pi-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Secrets
        run: |
          cd src
          echo "#define STRAVA_SECRET_KEY ${{ secrets.strava_secret_key }}" > secret.h
          echo "#define PELOTON_SECRET_KEY ${{ secrets.peloton_secret_key }}" >> secret.h
          echo "#define SMTP_USERNAME ${{ secrets.smtp_username }}" >> secret.h
          echo "#define SMTP_PASSWORD ${{ secrets.smtp_password }}" >> secret.h
          echo "#define SMTP_SERVER ${{ secrets.smtp_server }}" >> secret.h
          echo "${{ secrets.cesiumkey }}" >> inner_templates/googlemaps/cesium-key.js
          echo "#define LICENSE" >> secret.h
          cd ..
      - name: Build for Raspberry Pi
        uses: docker://arm32v7/debian:sid-20241016
        with:
          args: |
            bash -c "set -ex && 
            apt-get update && 
            apt-get install -y build-essential git cmake &&
            apt-get install -y ca-certificates apt-transport-https &&
            apt-get install -y $(apt-cache search --names-only 'qt6' | grep -v 'phonon4qt6' | awk '{print $1}') &&
            export QT_SELECT=qt6 &&
            export PATH=/usr/lib/qt6/bin:$PATH &&
            cd /github/workspace &&
            qmake6 &&
            make -j$(nproc)
            "
      - name: Rename binary
        run: mv src/qdomyos-zwift src/qdomyos-zwift-32bit
      
      - name: Archive Raspberry Pi binary
        uses: actions/upload-artifact@v4
        with:
          name: raspberry-pi-binary
          path: src/qdomyos-zwift-32bit

  raspberry-pi-build-and-image-64bit:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3
        with:
          image: tonistiigi/binfmt:master

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        with:
          version: v0.19.3

      - name: Secrets
        run: |
          cd src
          echo "#define STRAVA_SECRET_KEY ${{ secrets.strava_secret_key }}" > secret.h
          echo "#define PELOTON_SECRET_KEY ${{ secrets.peloton_secret_key }}" >> secret.h
          echo "#define SMTP_USERNAME ${{ secrets.smtp_username }}" >> secret.h
          echo "#define SMTP_PASSWORD ${{ secrets.smtp_password }}" >> secret.h
          echo "#define SMTP_SERVER ${{ secrets.smtp_server }}" >> secret.h
          echo "${{ secrets.cesiumkey }}" >> inner_templates/googlemaps/cesium-key.js
          echo "#define LICENSE" >> secret.h
          cd ..
      - name: Build for Raspberry Pi 64-bit
        uses: docker://arm64v8/debian:sid-20241016
        with:
          args: |
            bash -c "set -ex && 
            apt-get update && 
            apt-get install -y build-essential git cmake &&
            apt-get install -y ca-certificates apt-transport-https &&
            apt-get install -y $(apt-cache search --names-only 'qt6' | grep -v 'phonon4qt6' | awk '{print $1}') &&
            export QT_SELECT=qt6 &&
            export PATH=/usr/lib/qt6/bin:$PATH &&
            cd /github/workspace &&
            qmake6 &&
            make -j$(nproc)
            "
            
      - name: Rename binary
        run: mv src/qdomyos-zwift src/qdomyos-zwift-64bit

      - name: Archive Raspberry Pi binary
        uses: actions/upload-artifact@v4
        with:
          name: raspberry-pi-binary-64bit
          path: src/qdomyos-zwift-64bit        
          
      # Create a full Raspbian image with the application
      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y coreutils quilt parted qemu-user-static debootstrap zerofree zip dosfstools libarchive-tools libcap2-bin grep rsync xz-utils file git curl bc kpartx pigz arch-test
      - name: Clone pi-gen tool
        run: |
          git clone https://github.com/RPi-Distro/pi-gen.git
          cd pi-gen
          
          # Configure pi-gen for minimal Raspbian with our application
          echo "IMG_NAME=qdomyos-zwift-raspbian" > config
          echo "TARGET_HOSTNAME=qdomyos-zwift" >> config
          echo "ENABLE_SSH=1" >> config
          echo "FIRST_USER_NAME=pi" >> config
          echo "FIRST_USER_PASS=raspberry" >> config 
          echo "STAGE_LIST=\"stage0 stage1 stage2\"" >> config
          echo "DEPLOY_ZIP=1" >> config
      - name: Prepare custom stage for qdomyos-zwift
        run: |
          mkdir -p pi-gen/stage3/01-qdomyos-zwift/00-packages
          mkdir -p pi-gen/stage3/01-qdomyos-zwift/00-run-chroot
          mkdir -p pi-gen/stage3/01-qdomyos-zwift/01-files
          mkdir -p pi-gen/stage3/01-qdomyos-zwift/01-files/home/pi/qdomyos-zwift
          mkdir -p pi-gen/stage3/01-qdomyos-zwift/01-files/etc/systemd/system
          
          # Copy application binary
          cp src/qdomyos-zwift-64bit pi-gen/stage3/01-qdomyos-zwift/01-files/home/pi/qdomyos-zwift/qdomyos-zwift
          chmod +x pi-gen/stage3/01-qdomyos-zwift/01-files/home/pi/qdomyos-zwift/qdomyos-zwift
          
          # Create Qt dependencies package list
          echo "qt6-base-dev qt6-base-dev-tools libqt6widgets6 libqt6bluetooth6 libqt6positioning6 libqt6xml6 qt6-connectivity-dev qt6-positioning-dev libqt6charts6-dev libqt6charts6 libqt6networkauth6-dev libqt6websockets6-dev" > pi-gen/stage3/01-qdomyos-zwift/00-packages/00-packages-nr
          
          # Create systemd service file to autostart the application
          cat > pi-gen/stage3/01-qdomyos-zwift/01-files/etc/systemd/system/qdomyos-zwift.service << EOL
          [Unit]
          Description=QDomyos-Zwift Service
          After=network.target
          
          [Service]
          ExecStart=/home/pi/qdomyos-zwift/qdomyos-zwift
          WorkingDirectory=/home/pi/qdomyos-zwift
          User=pi
          Environment=DISPLAY=:0
          
          [Install]
          WantedBy=multi-user.target
          EOL
          
          # Setup script for enabling the service
          cat > pi-gen/stage3/01-qdomyos-zwift/00-run-chroot/01-setup-service << EOL
          #!/bin/bash
          systemctl enable qdomyos-zwift.service
          EOL
          chmod +x pi-gen/stage3/01-qdomyos-zwift/00-run-chroot/01-setup-service
      - name: Build Raspbian image
        run: |
          cd pi-gen
          sudo ./build.sh
          
      - name: Archive Raspberry Pi full image
        uses: actions/upload-artifact@v4
        with:
          name: qdomyos-zwift-raspbian-image
          path: pi-gen/deploy/*.zip

  upload_to_release:
    permissions: write-all
    runs-on: ubuntu-22.04 
    if: github.event_name == 'schedule'
    needs: [linux-x86-build, window-msvc2022-build, ios-build, window-build, android-build, raspberry-pi-build]  # Specify the job dependencies
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
        
      - name: Download artifacts
        uses: actions/download-artifact@v4
                  
      - name: Update nightly release
        uses: andelf/nightly-release@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: nightly-${{ steps.date.outputs.date }}
          prerelease: false
          name: 'QZ nightly build - ${{ steps.date.outputs.date }}'
          body: |
            This is a nightly build of QZ.
            You can use this if you want to try new features without waiting for releases.
            From time to time, in development builds, old difficult-to-reproduce bugs are
            fixed, but it is also true that in the development process with the introduction
            of new complex code, the stability of the program may suffer compared to
            official releases, so **use it with caution**!
            ## Windows Builds:
            - **windows-msvc2019**: Recommended for Windows 10
            - **windows-msvc2022**: Recommended for Windows 11 (experimental, QT6)
            - **windows**: MinGW build (alternative version)
            ## Other Platforms:
            - **fdroid-android-trial**: Android build
            - **raspberry-pi-binary**: Raspberry Pi build
            __Please help us improve QZ by reporting any issues you encounter!__ :wink:
          files: |
            windows-msvc2022-binary-no-python/*
            windows-msvc2022-binary/*
            windows-msvc2022-ai-server-binary/*            
            windows-binary-no-python/*
            windows-binary/*
            fdroid-android-trial/*
            raspberry-pi-binary/qdomyos-zwift-32bit
            raspberry-pi-binary/qdomyos-zwift-64bit
