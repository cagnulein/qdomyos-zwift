
# This is a basic workflow to help you get started with Actions

name: CI

env:
  DISPLAY: ':99'
  ACTIONS_ALLOW_UNSECURE_COMMANDS: 'true'

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  workflow_dispatch:
  push:
    branches: [ master,  github-workflow-playground ]
  pull_request:
    branches: [ master ]
  schedule:
    - cron: "0 0 * * *"

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  window-build:
    runs-on: windows-latest
    strategy:
      matrix:
        config:
          - {python: true}
          - {python: false}

    steps:
      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: bluetiger9/SmtpClient-for-Qt
          path: "src/smtpclient/"
          ref: 3fa4a0fe5797070339422cf18b5e9ed8dcb91f9c

      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: cagnulein/qmdnsengine
          path: "src/qmdnsengine/"
          ref: "zwift"   

      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: google/googletest
          path: "tst/googletest/"
          ref: "release-1.12.1"

      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: microsoft/MSIX-Toolkit
          path: "src/MSIX-Toolkit/"
          ref: b82af826d29e93e4c85d34fad8a405b6c49905e7

      - uses: actions/checkout@v2
      - name: Checkout qHttpServer
        uses: actions/checkout@v2
        with:
          repository: qt-labs/qthttpserver
          path: "src/qthttpserver"


      - uses: actions/setup-python@v4
        with:
          python-version: 3.7
      - name: download python and paddleocr
        run: |
          python -VV
          python -m pip install --upgrade pip
          python -m pip install --upgrade setuptools
          python -m pip install "protobuf<=3.20.2,>=3.1.0"
          python -m pip install paddlepaddle==2.5.1
          python -m pip install paddleocr
          python -m pip install imutils
          python -m pip install "Pillow<10.0.0"
          python -m pip install opencv-python
          python -m pip install numpy
          python -m pip install pywin32
        if: matrix.config.python

      - uses: msys2/setup-msys2@v2
        with:
          install: mingw-w64-x86_64-toolchain mingw-w64-x86_64-qt5-webview
          msystem: mingw64
          release: false

      - name: Setup cmake
        uses: jwlawson/actions-setup-cmake@v1.9
        with:
          cmake-version: '3.20.x'

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '5.15.2'
          host: 'windows'
          modules: 'qtnetworkauth qtcharts'
          target: "desktop"
          arch: win64_mingw81
          dir: "${{github.workspace}}/qt/"
          install-deps: "true"
          cache: 'true'
          cache-key-prefix: 'install-qt-action-windows'          

      - name: download 3rd party files for qthttpserver
        run: |
            cp qHttpServerBin/5.15.2/headers/* src/qthttpserver/src/3rdparty/http-parser/

      - name: Build qthttpserver
        run: |
            cd src\qthttpserver 
            qmake
            make -j8
            make install
            cd ../..

      - name: Secrets
        if: github.ref == 'refs/heads/master'
        run: |
          cd src
          echo "#define STRAVA_SECRET_KEY ${{ secrets.strava_secret_key }}" > secret.h
          echo "#define SMTP_USERNAME ${{ secrets.smtp_username }}" >> secret.h
          echo "#define SMTP_PASSWORD ${{ secrets.smtp_password }}" >> secret.h
          echo "#define SMTP_SERVER ${{ secrets.smtp_server }}" >> secret.h
          echo "${{ secrets.cesiumkey }}" >> inner_templates/googlemaps/cesium-key.js
          cd ..  

      - name: Build
        run: |
            qmake
            make -j8
            cd src/debug
            mkdir output
            mkdir appx
            cp qdomyos-zwift.exe output/
            cd output
            windeployqt --qmldir ../../ qdomyos-zwift.exe
            cp "C:/mingw64/bin/libwinpthread-1.dll" .
            cp "C:/mingw64/bin/libgcc_s_seh-1.dll" .
            cp "C:/mingw64/bin/libstdc++-6.dll" .
            cp ../../../icons/iOS/iTunesArtwork@2x.png .
            cp ../../AppxManifest.xml .
            cp ../../windows/*.py .
            cp ../../windows/*.bat .
            cp ../../../windows_openssl/*.* .
            mkdir adb
            mkdir python
            Copy-Item -Path C:\hostedtoolcache\windows\Python\3.7.9\x64 -Destination python -Recurse
            cp ../../adb/* adb/
            cd ..
            cd appx
            #../../MSIX-Toolkit/WindowsSDK/10/10.0.20348.0/x64/makeappx.exe pack /d ../output/ /p qz   
        if: matrix.config.python
            
      - name: Build without python
        run: |
            qmake
            make -j8
            cd src/debug
            mkdir output
            mkdir appx
            cp qdomyos-zwift.exe output/
            cd output
            windeployqt --qmldir ../../ qdomyos-zwift.exe
            cp "C:/mingw64/bin/libwinpthread-1.dll" .
            cp "C:/mingw64/bin/libgcc_s_seh-1.dll" .
            cp "C:/mingw64/bin/libstdc++-6.dll" .
            cp ../../../icons/iOS/iTunesArtwork@2x.png .
            cp ../../AppxManifest.xml .
            cp ../../../windows_openssl/*.* .
            mkdir adb
            cp ../../adb/* adb/
            cd ..
            cd appx
            #../../MSIX-Toolkit/WindowsSDK/10/10.0.20348.0/x64/makeappx.exe pack /d ../output/ /p qz          
        if: matrix.config.python == false

      - name: patching qt for bluetooth
        run: cp qt-patches/windows/5.15.2/binary/mingw64/*.* ${{ github.workspace }}/src/debug/output/

      - name: Zip artifact for deployment
        run: Compress-Archive src/debug/output windows-binary.zip
        if: matrix.config.python

      - name: Zip artifact for deployment
        run: Compress-Archive src/debug/output windows-binary-no-python.zip
        if:  ${{ ! matrix.config.python }}

      - name: Archive windows binary
        uses: actions/upload-artifact@v4
        with:
          name: windows-binary
          path: windows-binary.zip
        if: matrix.config.python

      - name: Archive windows binary
        uses: actions/upload-artifact@v4
        with:
          name: windows-binary-no-python
          path: windows-binary-no-python.zip
        if:  ${{ ! matrix.config.python }}

      # - name: Exit if not on master branch
      #   if: github.ref == 'refs/heads/master'
      #   run: exit 1

      # - uses: actions/checkout@v3
      #   with:
      #     fetch-depth: 0 # Required due to the way Git works, without it this action won't be able to find any or the correct tags

      # - name: Get previous tag
      #   id: previoustag
      #   uses: 'WyriHaximus/github-action-get-previous-tag@v1'
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}          

      # - name: Create Release
      #   if:  ${{ ! matrix.config.python }}
      #   id: create_release
      #   uses: actions/create-release@v1
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   with:
      #     tag_name: ${{ steps.previoustag.outputs.tag }}
      #     release_name: Release ${{ steps.previoustag.outputs.tag }}
      #     draft: false
      #     prerelease: false

      # - name: upload windows artifact
      #   uses: actions/upload-release-asset@v1
      #   if:  ${{ ! matrix.config.python }}
      #   env:
      #     GITHUB_TOKEN: ${{ github.token }}
      #   with:
      #     upload_url: ${{ steps.create_release.outputs.upload_url }}
      #     asset_path: release.zip
      #     asset_name: windows-binary-no-python.zip
      #     asset_content_type: application/zip        

      # - name: upload windows artifact
      #   uses: actions/upload-release-asset@v1
      #   if:  ${{ matrix.config.python }}
      #   env:
      #     GITHUB_TOKEN: ${{ github.token }}
      #   with:
      #     upload_url: ${{ steps.create_release.outputs.upload_url }}
      #     asset_path: release.zip
      #     asset_name: windows-binary.zip
      #     asset_content_type: application/zip        

#  window-steam-build:
#    runs-on: windows-latest
#
#    steps:
#      - uses: actions/checkout@v2
#      - name: Checkout submodule repo
#        uses: actions/checkout@v2
#        with:
#          repository: bluetiger9/SmtpClient-for-Qt
#          path: "src/smtpclient/"
#          ref: 3fa4a0fe5797070339422cf18b5e9ed8dcb91f9c
#
#      - uses: actions/checkout@v2
#      - name: Checkout submodule repo
#        uses: actions/checkout@v2
#        with:
#          repository: cagnulein/qmdnsengine
#          path: "src/qmdnsengine/"
#          ref: "zwift"
#
#      - uses: msys2/setup-msys2@v2
#        with:
#          install: mingw-w64-x86_64-toolchain
#          msystem: mingw64
#          release: false
#
#      - name: Setup cmake
#        uses: jwlawson/actions-setup-cmake@v1.9
#        with:
#          cmake-version: '3.20.x'
#
#      - name: Install Qt
#        uses: jurplel/install-qt-action@v2
#        with:
#          version: '5.15.2'
#          host: 'windows'
#          modules: 'qtnetworkauth qtcharts'
#          target: "desktop"
#          arch: win64_mingw81
#          dir: "${{github.workspace}}/qt/"
#          install-deps: "true"
#
#      - name: Build
#        run: |
#            qmake
#            cd src
#            echo "#define STRAVA_SECRET_KEY ${{ secrets.strava_secret_key }}" > secret.h
#            echo "#define SMTP_USERNAME ${{ secrets.smtp_username }}" >> secret.h
#            echo "#define SMTP_PASSWORD ${{ secrets.smtp_password }}" >> secret.h
#            echo "#define SMTP_SERVER ${{ secrets.smtp_server }}" >> secret.h
#            echo "${{ secrets.cesiumkey }}" >> inner_templates/googlemaps/cesium-key.js
#            echo "#define STEAM_STORE" >> secret.h
#            cd ..
#            make -j8
#            cd src/debug
#            mkdir output
#            mkdir appx
#            cp qdomyos-zwift.exe output/
#            cd output
#            windeployqt --qmldir ../../ qdomyos-zwift.exe
#            cp "${{github.workspace}}/qt/Qt/5.15.2/mingw81_64/bin/libwinpthread-1.dll" .
#            cp "${{github.workspace}}/qt/Qt/5.15.2/mingw81_64/bin/libgcc_s_seh-1.dll" .
#            cp "${{github.workspace}}/qt/Qt/5.15.2/mingw81_64/bin/libstdc++-6.dll" .
#
#      - uses: game-ci/steam-deploy@v1
#        with:
#          username: ${{ secrets.STEAM_USERNAME }}
#          password: ${{ secrets.STEAM_PASSWORD }}
#          configVdf: ${{ secrets.STEAM_CONFIG_VDF}}
#          ssfnFileName: ${{ secrets.STEAM_SSFN_FILE_NAME }}
#          ssfnFileContents: ${{ secrets.STEAM_SSFN_FILE_CONTENTS }}
#          appId: 2267200
#          buildDescription: 2.12
#          rootPath: src/debug/output
#          depot1Path: ./
#          #depot2Path: StandaloneLinux64
#          releaseBranch: prerelease

  # This workflow contains a single job called "build"
  linux-x86-build:
    # The type of runner that the job will run on
    runs-on: ubuntu-20.04

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: release
        uses: actions/create-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        id: create_release
        with:
          draft: false
          prerelease: false
          release_name: ${{ steps.version.outputs.version }}
          tag_name: ${{ github.ref }}
          body_path: CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ github.token }}

#      - name: Cache Qt Linux Desktop
#        id: cache-qt-linux-desktop
#        uses: actions/cache@v1
#        with:
#          path: '${{ github.workspace }}/output/linux-desktop/'
#          key: ${{ runner.os }}-QtCache-Linux-Desktop

#      - name: Cache Qt Linux Android
#        id: cache-qt-android
#        uses: actions/cache@v1
#        with:
#          path: '${{ github.workspace }}/output/android/'
#          key: ${{ runner.os }}-QtCache-Android

      - name: Xvfb install and run
        run: |
          sudo apt-get install -y xvfb
          Xvfb -ac ${{ env.DISPLAY }} -screen 0 1280x780x24 &

      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: bluetiger9/SmtpClient-for-Qt
          path: "src/smtpclient/"
          ref: 3fa4a0fe5797070339422cf18b5e9ed8dcb91f9c

      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: cagnulein/qmdnsengine
          path: "src/qmdnsengine/"
          ref: "zwift"

      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: google/googletest
          path: "tst/googletest/"
          ref: "release-1.12.1"

      - uses: actions/checkout@v2
      - name: Checkout qHttpServer
        uses: actions/checkout@v2
        with:
          repository: qt-labs/qthttpserver
          path: "src/qthttpserver"

      - name: Install packages required to run QZ inside workflow
        run: sudo apt update -y && sudo apt-get install -y qtbase5-dev qtchooser qt5-qmake qtbase5-dev-tools qtquickcontrols2-5-dev libqt5bluetooth5 libqt5widgets5 libqt5positioning5 libqt5xml5 qtconnectivity5-dev qtpositioning5-dev libqt5charts5-dev libqt5charts5 libqt5networkauth5-dev libqt5websockets5* libxcb-randr0-dev libxcb-xtest0-dev libxcb-xinerama0-dev libxcb-shape0-dev libxcb-xkb-dev

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '5.15.2'
          host: 'linux'
          modules: 'qtnetworkauth qtcharts'
          cache: 'true'
          cache-key-prefix: 'install-qt-action-linux'                    

      - name: download 3rd party files for qthttpserver
        run: |
            cp qHttpServerBin/5.15.2/headers/* src/qthttpserver/src/3rdparty/http-parser/

      - name: Build qthttpserver
        run: |
            cd src/qthttpserver 
            qmake
            make -j8
            make install
            cd ../..

      - name: Compile Linux Desktop
        run: qmake; make -j8

      - name: Archive linux-desktop binary
        uses: actions/upload-artifact@v4
        with:
          name: linux-desktop-binary
          path: src/qdomyos-zwift         

      - name: Test
        run: cd tst; GTEST_OUTPUT=xml:test-results/ GTEST_COLOR=1 ./qdomyos-zwift-tests; cd ..

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test_results_xml
          path: tst/test-results/**/*.xml               

#      - name: Test Peloton API
#        if: github.event_name == 'push' || github.event_name == 'schedule'
#        run: cd /home/runner/work/qdomyos-zwift/qdomyos-zwift/src/; ./qdomyos-zwift -test-peloton -peloton-username ${{ secrets.peloton_username }} -peloton-password ${{ secrets.peloton_password }}
#        timeout-minutes: 2

#      - name: Test Home Fitness Buddy API
#        run: cd /home/runner/work/qdomyos-zwift/qdomyos-zwift/src/; ./qdomyos-zwift -test-hfb
#        timeout-minutes: 2

#      - uses: actions/checkout@v2
#        with:
#          repository: nttld/setup-ndk
#          path: setup-ndk
      # The packages.json in nttld/setup-ndk has already been updated,
      # https://github.com/nttld/setup-ndk/commit/831db5b02a0f0cab80614619efe461a3dcc140e6
      # but `dist/*` has not been rebuilt yet. Build it.
      # https://github.com/nttld/setup-ndk/tree/main/dist
#      - name: Locally rebuilt setup-ndk
#        run: |
#          npm -prefix ./setup-ndk install
#          npm -prefix ./setup-ndk run all
      # Install using locally rebuilt setup-ndk
#      - name: Setup Android NDK r21d
#        uses: ./setup-ndk
      #- uses: nttld/setup-ndk@v1
#        with:
#          ndk-version: r21d

# waiting github.com/jurplel/install-qt-action/issues/63
#      - name: Install Qt Android
#        uses: jurplel/install-qt-action@v2
#        with:
#          version: '5.12.9'
#          host: 'linux'
#          target: 'android'
#          arch: 'android_armv7'
#          modules: 'qtcharts debug_info'
#          dir: '${{ github.workspace }}/output/android/'
#          cached: ${{ steps.cache-qt-android.outputs.cache-hit }}

#      - name: Compile Android
#        run: cd src; qmake; make -j4

#      - name: Install Qt MacOS
#        uses: jurplel/install-qt-action@v2
#        with:
#          version: '5.12.9'
#          host: 'mac'
#          target: 'desktop'
#          modules: 'qtcharts debug_info'
#          dir: '${{ github.workspace }}/output/macos/'

#      - name: Compile MacOS
#        run: cd src; qmake; make -j4


  # This workflow contains a single job called "build"
  android-build:
    # The type of runner that the job will run on
    runs-on: ubuntu-20.04

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
#      - name: Cache Qt Linux Desktop
#        id: cache-qt-linux-desktop
#        uses: actions/cache@v1
#        with:
#          path: '${{ github.workspace }}/output/linux-desktop/'
#          key: ${{ runner.os }}-QtCache-Linux-Desktop

#      - name: Cache Qt Linux Android
#        id: cache-qt-android
#        uses: actions/cache@v1
#        with:
#          path: '${{ github.workspace }}/output/android/'
#          key: ${{ runner.os }}-QtCache-Android

      - name: Xvfb install and run
        run: |
          sudo apt-get install -y xvfb
          Xvfb -ac ${{ env.DISPLAY }} -screen 0 1280x780x24 &

      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          # This token is provided by Actions, you do not need to create your own token
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive # or 'true' if you want to check out only immediate submodules

      - name: Install packages required to run QZ inside workflow
        run: sudo apt update -y && sudo apt-get install -y qtbase5-dev qtchooser qt5-qmake qtbase5-dev-tools qtquickcontrols2-5-dev libqt5bluetooth5 libqt5widgets5 libqt5positioning5 libqt5xml5 qtconnectivity5-dev qtpositioning5-dev libqt5charts5-dev libqt5charts5 libqt5networkauth5-dev libqt5websockets5* libxcb-randr0-dev libxcb-xtest0-dev libxcb-xinerama0-dev libxcb-shape0-dev libxcb-xkb-dev

#      - name: Test Peloton API
#        if: github.event_name == 'push' || github.event_name == 'schedule'
#        run: cd /home/runner/work/qdomyos-zwift/qdomyos-zwift/src/; ./qdomyos-zwift -test-peloton -peloton-username ${{ secrets.peloton_username }} -peloton-password ${{ secrets.peloton_password }}
#        timeout-minutes: 2

#      - name: Test Home Fitness Buddy API
#        run: cd /home/runner/work/qdomyos-zwift/qdomyos-zwift/src/; ./qdomyos-zwift -test-hfb
#        timeout-minutes: 2

#      - uses: actions/checkout@v2
#        with:
#          repository: nttld/setup-ndk
#          path: setup-ndk
      # The packages.json in nttld/setup-ndk has already been updated,
      # https://github.com/nttld/setup-ndk/commit/831db5b02a0f0cab80614619efe461a3dcc140e6
      # but `dist/*` has not been rebuilt yet. Build it.
      # https://github.com/nttld/setup-ndk/tree/main/dist
#      - name: Locally rebuilt setup-ndk
#        run: |
#          npm -prefix ./setup-ndk install
#          npm -prefix ./setup-ndk run all
      # Install using locally rebuilt setup-ndk
#      - name: Setup Android NDK r21d
#        uses: ./setup-ndk
      #- uses: nttld/setup-ndk@v1
#        with:
#          ndk-version: r21d

# waiting github.com/jurplel/install-qt-action/issues/63
      - name: Install Qt Android
        uses: jurplel/install-qt-action@v3
        with:
          version: '5.15.0'
          host: 'linux'
          target: 'android'
          arch: 'android'
          modules: 'qtcharts  qtnetworkauth'
          dir: '${{ github.workspace }}/output/android/'
          cache: 'true'
          cache-key-prefix: 'install-qt-action-android'                    

      - name: Install Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin' # See 'Supported distributions' for available options
          java-version: '11.0.23+9'
          
      - name: patching qt for bluetooth
        run: cp qt-patches/android/5.15.0/jar/*.* ${{ github.workspace }}/output/android/Qt/5.15.0/android/jar/

      - name: download 3rd party files for qthttpserver
        run: cp qHttpServerBin/5.15.2/headers/* src/qthttpserver/src/3rdparty/http-parser/

      - name: Set Android NDK 21 && build
        run: |
          # Install NDK 21 after GitHub update
          # https://github.com/actions/virtual-environments/issues/5595
          ANDROID_ROOT="/usr/local/lib/android"
          ANDROID_SDK_ROOT="${ANDROID_ROOT}/sdk"
          SDKMANAGER="${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager"
          echo "y" | $SDKMANAGER "ndk;21.4.7075529"
          export ANDROID_NDK="${ANDROID_SDK_ROOT}/ndk-bundle"
          export ANDROID_NDK_ROOT="${ANDROID_NDK}"
          cd src
          echo "#define STRAVA_SECRET_KEY ${{ secrets.strava_secret_key }}" > secret.h
          echo "#define SMTP_USERNAME ${{ secrets.smtp_username }}" >> secret.h
          echo "#define SMTP_PASSWORD ${{ secrets.smtp_password }}" >> secret.h
          echo "#define SMTP_SERVER ${{ secrets.smtp_server }}" >> secret.h
          echo "${{ secrets.cesiumkey }}" >> inner_templates/googlemaps/cesium-key.js
          echo "#define LICENSE" >> secret.h
          cd ..          

          ln -sfn $ANDROID_SDK_ROOT/ndk/21.4.7075529 $ANDROID_NDK
          rm -rf /usr/local/lib/android/sdk/ndk/25.1.8937393

          # QTHTTPSERVER must use the same NDK
          cd src/qthttpserver 
          qmake
          make -j8
          make install
          cd ../..          
          
          qmake -spec android-clang 'ANDROID_ABIS=armeabi-v7a arm64-v8a x86 x86_64' 'ANDROID_NDK_ROOT=/usr/local/lib/android/sdk/ndk/21.4.7075529' && make -j4 && make INSTALL_ROOT=${{ github.workspace }}/output/android/ install
          sed -i '1s|{|{\n   "android-extra-libs": "${{ github.workspace }}/android_openssl/no-asm/latest/arm/libcrypto_1_1.so,${{ github.workspace }}/android_openssl/no-asm/latest/arm/libssl_1_1.so,${{ github.workspace }}/android_openssl/no-asm/latest/arm64/libcrypto_1_1.so,${{ github.workspace }}/android_openssl/no-asm/latest/arm64/libssl_1_1.so,${{ github.workspace }}/android_openssl/no-asm/latest/x86/libcrypto_1_1.so,${{ github.workspace }}/android_openssl/no-asm/latest/x86/libssl_1_1.so,${{ github.workspace }}/android_openssl/no-asm/latest/x86_64/libcrypto_1_1.so,${{ github.workspace }}/android_openssl/no-asm/latest/x86_64/libssl_1_1.so",|' src/android-qdomyos-zwift-deployment-settings.json
          cat src/android-qdomyos-zwift-deployment-settings.json

      - name: Build APK (not usable for production due to unpatched QT library)
        run: cd src; androiddeployqt --input android-qdomyos-zwift-deployment-settings.json --output ${{ github.workspace }}/output/android/ --android-platform android-31 --gradle --aab

      - name: Archive apk binary
        uses: actions/upload-artifact@v4
        with:
          name: fdroid-android-trial
          path: ${{ github.workspace }}/output/android/build/outputs/apk/debug/

      # - name: Exit if not on master branch
      #   if: github.ref == 'refs/heads/master'
      #   run: exit 1

      # - name: upload windows artifact
      #   uses: actions/upload-release-asset@v1
      #   env:
      #     GITHUB_TOKEN: ${{ github.token }}
      #   with:
      #     upload_url: ${{ steps.create_release.outputs.upload_url }}
      #     asset_path: ${{ github.workspace }}/output/android/build/outputs/apk/debug/android-debug.apk
      #     asset_name: fdroid-android-trial.zip
      #     asset_content_type: application/zip                  

  ios-build:
    # The type of runner that the job will run on
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: bluetiger9/SmtpClient-for-Qt
          path: "src/smtpclient/"
          ref: 3fa4a0fe5797070339422cf18b5e9ed8dcb91f9c

      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: cagnulein/qmdnsengine
          path: "src/qmdnsengine/"
          ref: "zwift"

      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: google/googletest
          path: "tst/googletest/"
          ref: "release-1.12.1"

      - name: Install Qt iOS
        uses: jurplel/install-qt-action@v3
        with:
          version: '5.15.2'
          host: 'mac'
          target: 'ios'
          modules: 'qtcharts  qtnetworkauth'
          dir: '${{ github.workspace }}/output/ios/'
          cache: 'true'
          cache-key-prefix: 'install-qt-action-ios'                    
          
      - name: fix qt
        run: find ${{ github.workspace }}/output/ios/ -name 'ios.conf' -exec sed -i '' 's/ios-simulator/iphonesimulator/g' {} \;
      
      - name: fix qt
        run: find ${{ github.workspace }}/output/ios/ -name 'devices.py' -exec sed -i '' 's/\/usr\/bin\/python/\/usr\/bin\/python3/g' {} \;        

      - name: fix qt
        run: find ./ -name 'qdomyos-zwift-lib.pro' -exec sed -i '' 's/TARGET = qdomyos-zwift/TARGET = qdomyoszwift/g' {} \;                

      - name: patching qt for bluetooth
        run: cp qt-patches/ios/5.15.2/binary/*.* ${{ github.workspace }}/output/ios/Qt/5.15.2/ios/lib/

      - name: Build
        run: |
          cd src
          echo "#define STRAVA_SECRET_KEY ${{ secrets.strava_secret_key }}" > secret.h
          echo "#define SMTP_USERNAME ${{ secrets.smtp_username }}" >> secret.h
          echo "#define SMTP_PASSWORD ${{ secrets.smtp_password }}" >> secret.h
          echo "#define SMTP_SERVER ${{ secrets.smtp_server }}" >> secret.h
          echo "${{ secrets.cesiumkey }}" >> inner_templates/googlemaps/cesium-key.js
          cd ..
          qmake CONFIG+=debug && make -j4

      # causes iOS build on Mac to fail
      # - name: Commit moc files
      #   uses: EndBug/add-and-commit@v9
      #   with:
      #     message: 'moc files added'
      #     add: 'src/moc_*.cpp --force'
      #   if: github.ref == 'refs/heads/master'

  window-msvc2019-build:
    runs-on: windows-latest
    strategy:
      matrix:
        config:
          - {python: true}
          - {python: false}    

    steps:
      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: bluetiger9/SmtpClient-for-Qt
          path: "src/smtpclient/"
          ref: 3fa4a0fe5797070339422cf18b5e9ed8dcb91f9c

      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: cagnulein/qmdnsengine
          path: "src/qmdnsengine/"
          ref: "zwift"   

      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: google/googletest
          path: "tst/googletest/"
          ref: "release-1.12.1"

      - uses: actions/checkout@v2
      - name: Checkout qHttpServer
        uses: actions/checkout@v2
        with:
          repository: qt-labs/qthttpserver
          path: "src/qthttpserver"

      - uses: actions/setup-python@v4
        with:
          python-version: 3.7
      - name: download python and paddleocr
        run: |
          python -VV
          python -m pip install --upgrade pip
          python -m pip install --upgrade setuptools
          python -m pip install "protobuf<=3.20.2,>=3.1.0"
          python -m pip install paddlepaddle==2.5.1
          python -m pip install paddleocr
          python -m pip install imutils
          python -m pip install "Pillow<10.0.0"
          python -m pip install opencv-python
          python -m pip install numpy
          python -m pip install pywin32
        if: matrix.config.python          

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '5.15.2'
          host: 'windows'
          modules: 'qtnetworkauth qtcharts'
          target: "desktop"
          arch: win64_msvc2019_64
          dir: "${{github.workspace}}/qt/"
          install-deps: "true"
          cache: 'true'
          cache-key-prefix: 'install-qt-action-windows'          

      - name: Install MSVC compiler
        uses: ilammy/msvc-dev-cmd@v1
        with: 
          # 14.1 is for vs2017, 14.2 is vs2019, following the upstream vcpkg build from Qv2ray-deps repo
          toolset: 14.2
          arch: x64

      - name: download 3rd party files for qthttpserver
        run: |
            cp qHttpServerBin/5.15.2/headers/* src/qthttpserver/src/3rdparty/http-parser/

      - name: Build qthttpserver
        run: |
            cd src\qthttpserver 
            qmake
            nmake
            nmake install
            cd ../..          

      - name: Secrets
        if: github.ref == 'refs/heads/master'
        run: |
          cd src
          echo "#define STRAVA_SECRET_KEY ${{ secrets.strava_secret_key }}" > secret.h
          echo "#define SMTP_USERNAME ${{ secrets.smtp_username }}" >> secret.h
          echo "#define SMTP_PASSWORD ${{ secrets.smtp_password }}" >> secret.h
          echo "#define SMTP_SERVER ${{ secrets.smtp_server }}" >> secret.h
          echo "${{ secrets.cesiumkey }}" >> inner_templates/googlemaps/cesium-key.js
          cd ..        

      - name: Clone vcpkg
        run: git clone https://github.com/microsoft/vcpkg.git
        working-directory: ${{ runner.workspace }}
  
      - name: Bootstrap vcpkg
        run: .\vcpkg\bootstrap-vcpkg.bat
        working-directory: ${{ runner.workspace }}
        
      - name: Install dependencies
        run: |
          .\vcpkg\vcpkg install protobuf protobuf-c abseil
        working-directory: ${{ runner.workspace }}
  
      - name: Build
        run: |
            Copy-Item -Path ${{ runner.workspace }}\vcpkg\installed\x64-windows\lib\*.* -Destination . -Verbose
            Copy-Item -Path ${{ runner.workspace }}\vcpkg\installed\x64-windows\lib\*.* -Destination src/ -Verbose           
            Copy-Item -Path ${{ runner.workspace }}\vcpkg\installed\x64-windows\include\* -Destination src/ -Recurse -Verbose
            qmake            
            nmake
            cd src/debug
            mkdir output
            mkdir appx
            cp qdomyos-zwift.exe output/
            cd output
            windeployqt --qmldir ../../ qdomyos-zwift.exe
            cp ../../../icons/iOS/iTunesArtwork@2x.png .
            cp ../../AppxManifest.xml .
            cp ../../windows/*.py .
            cp ../../windows/*.bat .
            cp ../../../windows_openssl/*.* .
            Copy-Item -Path ${{ runner.workspace }}\vcpkg\installed\x64-windows\bin\*.* -Destination . -Verbose
            mkdir adb
            mkdir python
            Copy-Item -Path C:\hostedtoolcache\windows\Python\3.7.9\x64 -Destination python -Recurse
            cp ../../adb/* adb/
            cd ..
            cd appx
            #../../MSIX-Toolkit/WindowsSDK/10/10.0.20348.0/x64/makeappx.exe pack /d ../output/ /p qz   
        if: matrix.config.python
            
      - name: Build without python
        run: |          
            Copy-Item -Path ${{ runner.workspace }}\vcpkg\installed\x64-windows\lib\*.* -Destination . -Verbose
            Copy-Item -Path ${{ runner.workspace }}\vcpkg\installed\x64-windows\lib\*.* -Destination src/ -Verbose      
            Copy-Item -Path ${{ runner.workspace }}\vcpkg\installed\x64-windows\include\* -Destination src/ -Recurse -Verbose
            qmake           
            nmake
            cd src/debug
            mkdir output
            mkdir appx
            cp qdomyos-zwift.exe output/
            cd output
            windeployqt --qmldir ../../ qdomyos-zwift.exe
            cp "C:/mingw64/bin/libwinpthread-1.dll" .
            cp "C:/mingw64/bin/libgcc_s_seh-1.dll" .
            cp "C:/mingw64/bin/libstdc++-6.dll" .              
            cp ../../../icons/iOS/iTunesArtwork@2x.png .
            cp ../../AppxManifest.xml .
            cp ../../../windows_openssl/*.* .
            Copy-Item -Path ${{ runner.workspace }}\vcpkg\installed\x64-windows\bin\*.* -Destination . -Verbose
            mkdir adb
            cp ../../adb/* adb/
            cd ..
            cd appx
            #../../MSIX-Toolkit/WindowsSDK/10/10.0.20348.0/x64/makeappx.exe pack /d ../output/ /p qz          
        if: matrix.config.python == false            

      - name: patching qt for bluetooth
        run: cp qt-patches/windows/5.15.2/binary/msvc2019/*.* ${{ github.workspace }}/src/debug/output/

      - name: Zip artifact for deployment
        run: Compress-Archive src/debug/output windows-msvc2019-binary.zip
        if: matrix.config.python

      - name: Zip artifact for deployment
        run: Compress-Archive src/debug/output windows-msvc2019-binary-no-python.zip
        if:  ${{ ! matrix.config.python }}

      - name: Archive windows binary
        uses: actions/upload-artifact@v4
        with:
          name: windows-msvc2019-binary
          path: windows-msvc2019-binary.zip
        if: matrix.config.python

      - name: Archive windows binary
        uses: actions/upload-artifact@v4
        with:
          name: windows-msvc2019-binary-no-python
          path: windows-msvc2019-binary-no-python.zip
        if:  ${{ ! matrix.config.python }}

  window-msvc2019-aiserver-build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: bluetiger9/SmtpClient-for-Qt
          path: "src/smtpclient/"
          ref: 3fa4a0fe5797070339422cf18b5e9ed8dcb91f9c

      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: cagnulein/qmdnsengine
          path: "src/qmdnsengine/"
          ref: "zwift"   

      - uses: actions/checkout@v2
      - name: Checkout submodule repo
        uses: actions/checkout@v2
        with:
          repository: google/googletest
          path: "tst/googletest/"
          ref: "release-1.12.1"

      - uses: actions/checkout@v2
      - name: Checkout qHttpServer
        uses: actions/checkout@v2
        with:
          repository: qt-labs/qthttpserver
          path: "src/qthttpserver"      

      - name: Install CMake
        uses: lukka/get-cmake@latest
  
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '5.15.2'
          host: 'windows'
          modules: 'qtnetworkauth qtcharts'
          target: "desktop"
          arch: win64_msvc2019_64
          dir: "${{github.workspace}}/qt/"
          install-deps: "true"
          cache: 'true'
          cache-key-prefix: 'install-qt-action-windows'          

      - name: Install MSVC compiler
        uses: ilammy/msvc-dev-cmd@v1
        with: 
          # 14.1 is for vs2017, 14.2 is vs2019, following the upstream vcpkg build from Qv2ray-deps repo
          toolset: 14.2
          arch: x64

      - name: download 3rd party files for qthttpserver
        run: |
            cp qHttpServerBin/5.15.2/headers/* src/qthttpserver/src/3rdparty/http-parser/

      - name: Build qthttpserver
        run: |
            cd src\qthttpserver 
            qmake
            nmake
            nmake install
            cd ../..          

      - name: Secrets
        if: github.ref == 'refs/heads/master'
        run: |
          cd src
          echo "#define STRAVA_SECRET_KEY ${{ secrets.strava_secret_key }}" > secret.h
          echo "#define SMTP_USERNAME ${{ secrets.smtp_username }}" >> secret.h
          echo "#define SMTP_PASSWORD ${{ secrets.smtp_password }}" >> secret.h
          echo "#define SMTP_SERVER ${{ secrets.smtp_server }}" >> secret.h          
          echo "${{ secrets.cesiumkey }}" >> inner_templates/googlemaps/cesium-key.js
          cd ..                    

      - name: Clone vcpkg
        run: git clone https://github.com/microsoft/vcpkg.git
        working-directory: ${{ runner.workspace }}
  
      - name: Bootstrap vcpkg
        run: .\vcpkg\bootstrap-vcpkg.bat
        working-directory: ${{ runner.workspace }}
        
      - name: Install dependencies
        run: |
          .\vcpkg\vcpkg install protobuf protobuf-c abseil
        working-directory: ${{ runner.workspace }}

      - name: Build
        run: |
            Copy-Item -Path ${{ runner.workspace }}\vcpkg\installed\x64-windows\lib\*.* -Destination . -Verbose
            Copy-Item -Path ${{ runner.workspace }}\vcpkg\installed\x64-windows\lib\*.* -Destination src/ -Verbose           
            Copy-Item -Path ${{ runner.workspace }}\vcpkg\installed\x64-windows\include\* -Destination src/ -Recurse -Verbose
            cd src
            echo "#define AISERVER" >> aiserver.h
            cd ..
            qmake
            nmake
            cd src/debug
            mkdir output
            mkdir appx
            cp qdomyos-zwift.exe output/
            cd output
            windeployqt --qmldir ../../ qdomyos-zwift.exe
            cp ../../../icons/iOS/iTunesArtwork@2x.png .
            cp ../../AppxManifest.xml .
            cp ../../windows/zwift-incline-ai-server.py zwift-incline.py
            cp ../../windows/zwift-incline-climb-portal-ai-server.py zwift-incline-climb-portal.py
            cp ../../windows/zwift-workout-ai-server.py zwift-workout.py
            cp ../../windows/*.bat .
            cp ../../../windows_openssl/*.* .
            Copy-Item -Path ${{ runner.workspace }}\vcpkg\installed\x64-windows\bin\*.* -Destination . -Verbose
            mkdir adb
            cp ../../adb/* adb/
            cd ..
            cd appx
            #../../MSIX-Toolkit/WindowsSDK/10/10.0.20348.0/x64/makeappx.exe pack /d ../output/ /p qz                      

      - name: patching qt for bluetooth
        run: cp qt-patches/windows/5.15.2/binary/msvc2019/*.* ${{ github.workspace }}/src/debug/output/

      - name: Zip artifact for deployment
        run: Compress-Archive src/debug/output windows-msvc2019-ai-server-binary.zip

      - name: Archive windows binary
        uses: actions/upload-artifact@v4
        with:
          name: windows-msvc2019-ai-server-binary
          path: windows-msvc2019-ai-server-binary.zip

  raspberry-pi-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Secrets
        run: |
          cd src
          echo "#define STRAVA_SECRET_KEY ${{ secrets.strava_secret_key }}" > secret.h
          echo "#define SMTP_USERNAME ${{ secrets.smtp_username }}" >> secret.h
          echo "#define SMTP_PASSWORD ${{ secrets.smtp_password }}" >> secret.h
          echo "#define SMTP_SERVER ${{ secrets.smtp_server }}" >> secret.h
          echo "${{ secrets.cesiumkey }}" >> inner_templates/googlemaps/cesium-key.js
          echo "#define LICENSE" >> secret.h
          cd ..

      - name: Build for Raspberry Pi
        uses: docker://arm32v7/debian:bullseye
        with:
          args: >
            bash -c "
            set -ex &&
            apt-get update && 
            apt-get install -y build-essential git cmake qtbase5-dev qtchooser qt5-qmake qtbase5-dev-tools qttools5-dev-tools libqt5svg5-dev qtmultimedia5-dev libqt5charts5-dev qtpositioning5-dev qtconnectivity5-dev libqt5websockets5-dev libqt5texttospeech5-dev libqt5bluetooth5 libqt5networkauth5-dev qml-module-qtlocation qml-module-qtpositioning qtlocation5-dev libqt5quickcontrols2-5 qtquickcontrols2-5-dev qml-module-qtquick-controls2 &&
            export QT_SELECT=qt5 &&
            export PATH=/usr/lib/qt5/bin:$PATH &&
            cd /github/workspace &&
            sed -i '/QtHttpServer/d' qdomyos-zwift.pro &&
            find src -type f \( -name '*.cpp' -o -name '*.h' \) -exec sed -i 's/#include <QtHttpServer/\/\/#include <QtHttpServer/' {} + &&
            find src -type f \( -name '*.cpp' -o -name '*.h' \) -exec sed -i 's/QHttpServer/\/\/QHttpServer/' {} + &&
            cat qdomyos-zwift.pro &&
            qmake &&
            make -j$(nproc)
            "

      - name: Archive Raspberry Pi binary
        uses: actions/upload-artifact@v4
        with:
          name: raspberry-pi-binary
          path: src/qdomyos-zwift

  raspberry-pi-build-and-image-64bit:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Secrets
        run: |
          cd src
          echo "#define STRAVA_SECRET_KEY ${{ secrets.strava_secret_key }}" > secret.h
          echo "#define SMTP_USERNAME ${{ secrets.smtp_username }}" >> secret.h
          echo "#define SMTP_PASSWORD ${{ secrets.smtp_password }}" >> secret.h
          echo "#define SMTP_SERVER ${{ secrets.smtp_server }}" >> secret.h
          echo "${{ secrets.cesiumkey }}" >> inner_templates/googlemaps/cesium-key.js
          echo "#define LICENSE" >> secret.h
          cd ..

      - name: Build for Raspberry Pi 64-bit
        uses: docker://arm64v8/debian:bullseye
        with:
          args: >
            bash -c "
            set -ex &&
            apt-get update && 
            apt-get install -y build-essential git cmake qtbase5-dev qtchooser qt5-qmake qtbase5-dev-tools qttools5-dev-tools libqt5svg5-dev qtmultimedia5-dev libqt5charts5-dev qtpositioning5-dev qtconnectivity5-dev libqt5websockets5-dev libqt5texttospeech5-dev libqt5bluetooth5 libqt5networkauth5-dev qml-module-qtlocation qml-module-qtpositioning qtlocation5-dev libqt5quickcontrols2-5 qtquickcontrols2-5-dev qml-module-qtquick-controls2 &&
            export QT_SELECT=qt5 &&
            export PATH=/usr/lib/qt5/bin:$PATH &&
            cd /github/workspace &&
            sed -i '/QtHttpServer/d' qdomyos-zwift.pro &&
            find src -type f \( -name '*.cpp' -o -name '*.h' \) -exec sed -i 's/#include <QtHttpServer/\/\/#include <QtHttpServer/' {} + &&
            find src -type f \( -name '*.cpp' -o -name '*.h' \) -exec sed -i 's/QHttpServer/\/\/QHttpServer/' {} + &&
            cat qdomyos-zwift.pro &&
            qmake &&
            make -j$(nproc)
            "

      - name: Archive Raspberry Pi binary
        uses: actions/upload-artifact@v4
        with:
          name: raspberry-pi-64bit-binary
          path: src/qdomyos-zwift

      - name: Download and expand Raspberry Pi OS image
        run: |
          wget https://downloads.raspberrypi.org/raspios_lite_arm64/images/raspios_lite_arm64-2023-05-03/2023-05-03-raspios-bullseye-arm64-lite.img.xz
          xz -d 2023-05-03-raspios-bullseye-arm64-lite.img.xz
          ORIGINAL_SIZE=$(stat -c %s 2023-05-03-raspios-bullseye-arm64-lite.img)
          NEW_SIZE=$((ORIGINAL_SIZE + 2*1024*1024*1024))  # Add 2GB
          truncate -s $NEW_SIZE 2023-05-03-raspios-bullseye-arm64-lite.img
          sudo apt-get update
          sudo apt-get install -y parted
          sudo parted 2023-05-03-raspios-bullseye-arm64-lite.img resizepart 2 100%

      - name: Mount Raspberry Pi image
        run: |
          sudo apt-get install -y kpartx qemu-user-static
          LOOP_DEVICE=$(sudo losetup -f --show 2023-05-03-raspios-bullseye-arm64-lite.img)
          echo "Loop device is $LOOP_DEVICE"
          sudo kpartx -av $LOOP_DEVICE
          sudo mkdir -p /mnt/raspbian
          sudo mount /dev/mapper/$(basename $LOOP_DEVICE)p2 /mnt/raspbian
          sudo resize2fs /dev/mapper/$(basename $LOOP_DEVICE)p2
          echo "LOOP_DEVICE=$LOOP_DEVICE" >> $GITHUB_ENV
          sudo cp /usr/bin/qemu-aarch64-static /mnt/raspbian/usr/bin/

      - name: Install Qt and dependencies on Raspberry Pi image
        run: |
          sudo chroot /mnt/raspbian qemu-aarch64-static /bin/bash << EOF
          apt-get update
          apt-get install -y qtbase5-dev qtchooser qt5-qmake qtbase5-dev-tools qttools5-dev-tools libqt5svg5-dev qtmultimedia5-dev libqt5charts5-dev qtpositioning5-dev qtconnectivity5-dev libqt5websockets5-dev libqt5texttospeech5-dev libqt5bluetooth5 libqt5networkauth5-dev qml-module-qtlocation qml-module-qtpositioning qtlocation5-dev libqt5quickcontrols2-5 qtquickcontrols2-5-dev qml-module-qtquick-controls2
          EOF

      - name: Copy binary to Raspberry Pi image
        run: |
          sudo cp src/qdomyos-zwift /mnt/raspbian/home/pi/
          sudo chown 1000:1000 /mnt/raspbian/home/pi/qdomyos-zwift

      - name: Setup auto-start for qdomyos-zwift
        run: |
          echo '[Unit]
          Description=QDomyos-Zwift
          After=multi-user.target

          [Service]
          ExecStart=/home/pi/qdomyos-zwift
          User=pi
          Environment=DISPLAY=:0

          [Install]
          WantedBy=multi-user.target' | sudo tee /mnt/raspbian/etc/systemd/system/qdomyos-zwift.service
          sudo chroot /mnt/raspbian systemctl enable qdomyos-zwift.service

      - name: Unmount Raspberry Pi image
        run: |
          sudo umount /mnt/raspbian
          sudo kpartx -d ${{ env.LOOP_DEVICE }}
          sudo losetup -d ${{ env.LOOP_DEVICE }}

      - name: Compress modified Raspberry Pi image
        run: |
          xz -z 2023-05-03-raspios-bullseye-arm64-lite.img

      - name: Upload Raspberry Pi image as artifact
        uses: actions/upload-artifact@v4
        with:
          name: raspberry-pi-64bit-image
          path: 2023-05-03-raspios-bullseye-arm64-lite.img.xz
  
  upload_to_release:
    permissions: write-all
    runs-on: ubuntu-20.04 
    if: github.event_name == 'schedule'
    needs: [linux-x86-build, window-msvc2019-build, ios-build, window-build, android-build]  # Specify the job dependencies
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
      - name: Update nightly release
        uses: andelf/nightly-release@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: nightly
          prerelease: false
          name: 'QZ nightly build $$'
          body: |
            This is a nightly build of QZ.

            You can use this if you want to try new features without waiting for releases.
            From time to time, in development builds, old difficult-to-reproduce bugs are
            fixed, but it is also true that in the development process with the introduction
            of new complex code, the stability of the program may suffer compared to
            official releases, so **use it with caution**!

            __Please help us improve QZ by reporting any issues you encounter!__ :wink:
          files: |
            windows-msvc2019-binary-no-python/*
            windows-msvc2019-binary/*
            windows-msvc2019-ai-server-binary/*            
            windows-binary-no-python/*
            windows-binary/*
            fdroid-android-trial/*
            raspberry-pi-binary/*
            raspberry-pi-64bit-binary/*
            2023-05-03-raspios-bullseye-arm64-lite.img.xz


  
